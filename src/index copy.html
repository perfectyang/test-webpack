<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" >
  <title>webpack</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
</head>

<body >
<div id="app">
</div>
<script>
const forEach = (obj, callback) => {
  Object.keys(obj).forEach(key => {
    callback(key, obj[key])
  })
}
const json = {
  state: {
    a: 1,
  },
  module: {
    son: {
      state: {
        y: 11
      },
      mutations: {
        add (state, payload) {
          console.log('里面')
          state.y += payload
        }
      },
      getters: {
        aState(state) {
          return state.y
        }
      },
      module: {
        grandson: {
          state: 'grandson'
        },
        grandson2: {
          state: 'grandson2'
        }
      }
    },
    son2: {
      state: {
        y: 11
      },
      mutations: {
        add (state, payload) {
          console.log('里面')
          state.y += payload
        }
      },
      getters: {
        aState(state) {
          return state.y
        }
      }
    }
  },
  actions: {
    syncAdd ({commit, dispatch}, payload) {
      commit('add', payload)
    }
  },
  getters: {
    outState(state) {
      return state.a
    }
  },
  mutations: {
    add (state, payload) {
      console.log('外面')
      state.a += payload
    }
  }
}
let root
function register (path, rootModule) {
  let newModule = {
    _raw: rootModule,
    _children: {},
    state: rootModule.state
  }
  if (path.length === 0) {
    root = newModule
  } else {
    let parent = path.slice(0, -1).reduce((root, current) => {
      return root._children[current]
    }, root)
    parent._children[path[path.length - 1]] = newModule
  }
  if (rootModule.module) {
    forEach(rootModule.module, (moduleName, module) => {
      register(path.concat(moduleName), module)
    })
  }
}

register([], json)
console.log(root)
const testJson = {
  state: '11',
  children: [
    {
      state: '222',
      children: [
        {
          state: '333'
        },
        {
          state: '444'
        }
      ]
    },
    {
      state: '7777',
      children: [
        {
          state: '5555'
        },
        {
          state: '6666'
        }
      ]
    }
  ]
}

let root2

function register2 (path, rootModule) {
  let newModule = {
    _raw: rootModule,
    _children: [],
    state: rootModule.state
  }
  if (path.length === 0) {
    root2 = newModule
  } else {
    let parent = path.slice(0, -1).reduce((root, current) => {
      return root._children[current]
    }, root2)
    console.log('newModule', newModule.state)
    const curIdx = path[path.length - 1]
    parent._children[curIdx] = newModule
  }
  if (rootModule.children) {
    rootModule.children.forEach((child, idx) => {
      register2(path.concat(idx), child)
    })
  }
}

register2([], testJson)

console.log('root2', root2)


</script>
</body>

</html>